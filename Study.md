# 版本 1.0.1

## 添加service层，并可以Yii::$service使用

#### 一.service层的好处

- 1.1 很多的中间层逻辑写到`controller`中，造成`controller`非常庞大
- 1.2 `controller`层，是`调度层`，在里面写的中间逻辑，其他的`controller`文件`无法重复利用`

- 1.3 有一些逻辑，是需要很多`model`完成，譬如`生成订单`操作，需要`订单生成`，`扣除库存`，`优惠券扣除`，`物车清空`等多个model协作实现， 这些逻辑写到某个`model`里显然不合适，如果写到`controller`里面，代码`重复利用`不高

- 1.4 对于多设备电商，各个`入口`对数据的操作，`参数配置`需要一致， 这样写到controller里面的一些代码，无法重复利用，需要多处实现， 维护起来非常费劲（需求变动，需要多处维护）

- 1.5 后期重构，如果将`cart model`由`mysql`换成`redis`，那么非常的费劲，需要各个`入口`的逻辑都要修改。

- 1.6 公司技术架构做成`服务总线`，某些数据需要`api`调取，需要将`model`重构为`api`，维护起来非常麻烦

#### 二.实现

Service是通过`配置注入`，`容器生成`等技术实现的`单例模式对象`，可以通过配置注入参数到`实例化对象`中 `懒加载`模式，调用的时候才会`实例化`，这样不会有额外的开销。

`controller`层或者`block`层，调用`service`层函数，然后由`service`调用`model`层数据，或者其他的`service`的方法，进行逻辑数据处理， 将结果返回`调用方`。

对于多入口电商系统，各个入口有独自的`controller`，但service层`公用`，这样如果改动了`service`层的实现，或者通过插件扩展`重构service`层， 即可把所有的入口都修改，方便维护

可以实现多个services，譬如`mysql cart services`， `redis cart services`，然后通过配置重写，即可完成底层的重构, 譬如fecmall对产品部分，有`mysql`和`mongodb`两种services实现，您可以在后台配置，选择使用那种数据库存储产品数据,如图：

对于存储底层，除了mysql，mongodb，redis等本地数据库外，不局限于数据库，您可以将远程的`api`封装到`service`里面（将远程的`api`看成`数据库`） ，这样，对于业务晋升快的公司，很有帮助。

#### 三.具体实现步骤

- 3.1 在yii官网下载advanced版本，并composer安装

- 3.2 设置域名访问到`frontend\web\index.php`

- 3.3 修改`frontend\web\index.php`文件，引入重写后的Yii.php文件（`yiiCore/Yii.php`）

- 3.4 在项目根目录创建文件夹yiiCore，并在其下创建Yii.php文件

- 3.5 设置setAlias，文件位置`common\config\bootstrap.php`

  ```php
  Yii::setAlias('@services', dirname(dirname(__DIR__)) . '/services')
  ```

- 3.6 根目录下创建文件夹services，并创建文件Application.php 用于注入容器

- 3.7 services下创建文件Service.php 公共父类,切记：`service类及其子类不要重写构造函数`
- 3.8 services下创建文件Admin.php 继承公共父类
- 3.9 `common\config`下创建service文件夹，包括所有service配置
- 3.10 `common\config`下创建service.php文件，加载所有service配置文件
- 3.11 测试

```php
  # /services/Admin.php
  class Admin extends Service
  {
      public function init() 
      {
        echo "初始化admin" . PHP_EOL;
        parent::init(); // TODO: Change the autogenerated stub
      }
  
      public function getId() 
      {
          return 8;
      }
  }
```

  

```php
# frontend\controllers\SiteController.php
/**
     * Displays homepage.
     *
     * @return mixed
     */
    public function actionIndex()
    {
        print_r(Yii::$service->admin->getId());
        print_r(Yii::$service->admin->getId());
        //return $this->render('index');
    }
```

- 3.12 访问，调用两次实例化一次，说明是单例

```php
# 访问输出结果
初始化admin 888
```

- 3.13 Yii:$service->admin引入子服务menu，实现Yii:$service->admin->menu->getMenu()这样访问。在Menu.php文件中不要重写构造函数。

```php
# common\config\services\Admin.php
return [
    'admin' => [
        'class' => 'services\Admin',
        // 子服务
        'childService' => [
            'menu' => [
                'class'        => 'services\admin\Menu',

            ],
        ],
    ]
];
```

```php
# services\admin\Menu
<?php

namespace services\admin;

use services\Service;

class Menu extends Service
{
    public function getMenu() {
        echo '我是菜单';
    }
}
```
```PHP
# 访问输出结果
初始化admin 888
我是菜单
```

